import { useParams } from "react-router-dom";
import { useEffect, useState } from "react";
import axios from "axios";
import { MainLayout } from "@/components/layouts/MainLayout";
import { PageWrapper } from "@/components/layouts/PageWrapper";
import { API_ROUTES } from "@/config/apiRoutes";

export default function VulnerabilityDetails() {
  const { cveId } = useParams();
  const [vuln, setVuln] = useState(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    axios.get(API_ROUTES.VULNERABILITIES.DETAIL(cveId), { withCredentials: true })
      .then((res) => setVuln(res.data))
      .catch((err) => console.error("Error loading CVE detail:", err))
      .finally(() => setLoading(false));
  }, [cveId]);

  if (loading) {
    return (
      <MainLayout>
        <PageWrapper>
          <p className="text-muted-foreground">Cargando detalles de la vulnerabilidad...</p>
        </PageWrapper>
      </MainLayout>
    );
  }

  if (!vuln) {
    return (
      <MainLayout>
        <PageWrapper>
          <p className="text-red-600">No se encontró información para {cveId}</p>
        </PageWrapper>
      </MainLayout>
    );
  }

  const {
    cve_id, descripcion, references = [],
    source_identifier, published, status, cwe = [],
    cvss_version, score, vector, severity,
    exploitability_score, impact_score, user_interaction_required,
    obtain_all_privileges, obtain_user_privileges, obtain_other_privileges,
    attack_vector, attack_complexity, privileges_required,
    user_interaction, scope,
    confidentiality_impact, integrity_impact, availability_impact,
    access_vector, access_complexity, authentication
  } = vuln;

  return (
    <MainLayout>
      <PageWrapper>
        {/* Nivel 1: Prioridad Alta */}
        <h1 className="text-3xl font-bold mb-3 text-blue-700">{cve_id}</h1>
        <p className="text-base text-muted-foreground mb-6">{descripcion}</p>

        <section className="mb-6">
          <h2 className="text-xl font-semibold text-blue-600">Referencias</h2>
          <ul className="list-disc pl-6 mt-2 text-sm text-blue-800">
            {references.map((r, i) => (
              <li key={i}><a href={r.url} target="_blank" rel="noopener noreferrer" className="hover:underline">{r.url}</a></li>
            ))}
          </ul>
          <p className="text-xs mt-1 italic text-muted-foreground">Aquí pueden encontrarse posibles parches o soluciones</p>
        </section>

        {/* Nivel 2: Prioridad media */}
        <section className="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
          <div><strong>Identificador fuente:</strong> {source_identifier}</div>
          <div><strong>Fecha de publicación:</strong> {published}</div>
          <div><strong>Estado:</strong> {status}</div>
          <div><strong>CWE asociado:</strong> {cwe.join(", ") || "N/A"}</div>
        </section>

        {/* Nivel 3: Detalles técnicos menos prioritarios */}
        <section>
          <h3 className="text-lg font-semibold mb-2 text-gray-700">Detalles técnicos</h3>
          <div className="grid grid-cols-1 sm:grid-cols-2 gap-3 text-sm text-muted-foreground">
            <div><strong>CVSS Version:</strong> {cvss_version}</div>
            <div><strong>Score:</strong> {score}</div>
            <div><strong>Vector:</strong> {vector}</div>
            <div><strong>Severidad:</strong> {severity}</div>
            <div><strong>Exploitability Score:</strong> {exploitability_score}</div>
            <div><strong>Impact Score:</strong> {impact_score}</div>
            <div><strong>User Interaction Required:</strong> {user_interaction_required}</div>
            <div><strong>Obtain All Privileges:</strong> {obtain_all_privileges}</div>
            <div><strong>Obtain User Privileges:</strong> {obtain_user_privileges}</div>
            <div><strong>Obtain Other Privileges:</strong> {obtain_other_privileges}</div>
            <div><strong>Attack Vector:</strong> {attack_vector}</div>
            <div><strong>Attack Complexity:</strong> {attack_complexity}</div>
            <div><strong>Privileges Required:</strong> {privileges_required}</div>
            <div><strong>User Interaction:</strong> {user_interaction}</div>
            <div><strong>Scope:</strong> {scope}</div>
            <div><strong>Confidentiality Impact:</strong> {confidentiality_impact}</div>
            <div><strong>Integrity Impact:</strong> {integrity_impact}</div>
            <div><strong>Availability Impact:</strong> {availability_impact}</div>
            <div><strong>Access Vector:</strong> {access_vector}</div>
            <div><strong>Access Complexity:</strong> {access_complexity}</div>
            <div><strong>Authentication:</strong> {authentication}</div>
          </div>
        </section>
      </PageWrapper>
    </MainLayout>
  );
}
